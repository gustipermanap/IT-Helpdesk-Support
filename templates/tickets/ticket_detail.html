{% extends "base.html" %}
{% block title %}Ticket {{ ticket.ticket_id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h3 class="mb-1">Ticket {{ ticket.ticket_id }}</h3>
    <div class="text-muted">{{ ticket.subject }}</div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'dashboard' %}">Back</a>
  </div>
</div>

<div class="row g-3">
  <!-- Left: Ticket summary -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted">Status</span>
          {% if ticket.status == "NEW" %}
          <span class="badge text-bg-secondary">New</span>
          {% elif ticket.status == "IN_PROGRESS" %}
          <span class="badge text-bg-primary">In Progress</span>
          {% elif ticket.status == "WAITING_EMPLOYEE" %}
          <span class="badge text-bg-warning">Waiting for Employee</span>
          {% elif ticket.status == "RESOLVED" %}
          <span class="badge text-bg-success">Resolved</span>
          {% elif ticket.status == "CLOSED" %}
          <span class="badge text-bg-dark">Closed</span>
          {% else %}
          <span class="badge text-bg-secondary">{{ ticket.get_status_display }}</span>
          {% endif %}
        </div>

        <hr class="my-3">

        <p class="mb-2"><span class="text-muted">Department:</span> <span class="fw-semibold">{{ ticket.department
            }}</span></p>
        <p class="mb-2"><span class="text-muted">Employee:</span> <span class="fw-semibold">{{ ticket.employee.username
            }}</span></p>
        <p class="mb-2"><span class="text-muted">Assigned Support:</span>
          <span class="fw-semibold">{{ ticket.assigned_support.username|default:"â€”" }}</span>
        </p>

        <hr class="my-3">

        <p class="mb-1 text-muted">Created</p>
        <p class="mb-3">{{ ticket.created_at|date:"M d, Y H:i" }}</p>

        <p class="mb-1 text-muted">Last Updated</p>
        <p class="mb-0">{{ ticket.updated_at|date:"M d, Y H:i" }}</p>
      </div>
    </div>

    {% if manager_form %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <strong>Manager Update</strong>
      </div>
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          <input type="hidden" name="form_type" value="manager_update" />

          <div class="mb-3">
            <label class="form-label">Status</label>
            {{ manager_form.status }}
          </div>

          <div class="mb-3">
            <label class="form-label">Assign Support</label>
            {{ manager_form.assigned_support }}
          </div>

          <div class="mb-3">
            <label class="form-label">Internal Notes</label>
            {{ manager_form.internal_notes }}
          </div>

          <button class="btn btn-primary" type="submit">Update</button>
        </form>
      </div>
    </div>
    {% elif support_form %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <strong>Support Update</strong>
      </div>
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          <input type="hidden" name="form_type" value="support_update" />

          <div class="mb-3">
            <label class="form-label">Status</label>
            {{ support_form.status }}
          </div>

          <button class="btn btn-primary" type="submit">Update</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Right: Tabs -->
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">

        <ul class="nav nav-tabs" id="ticketTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details"
              type="button" role="tab">Details</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments"
              type="button" role="tab">
              Attachments <span class="badge text-bg-light ms-1">{{ ticket.attachments.count }}</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button"
              role="tab">
              Comments <span class="badge text-bg-light ms-1">{{ ticket.comments.count }}</span>
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3">

          <!-- Details -->
          <div class="tab-pane fade show active" id="details" role="tabpanel">
            <h5 class="mb-2">Description</h5>
            <div class="p-3 bg-light rounded border">
              {{ ticket.description|linebreaksbr }}
            </div>
          </div>

          <!-- Attachments -->
          <div class="tab-pane fade" id="attachments" role="tabpanel">
            {% if ticket.attachments.all %}
            <div class="list-group">
              {% for a in ticket.attachments.all %}
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                href="{{ a.file.url }}" target="_blank">
                <div class="text-truncate" style="max-width: 75%;">
                  {{ a.file.name }}
                  <div class="small text-muted">Uploaded: {{ a.uploaded_at|date:"M d, Y H:i" }}</div>
                </div>
                <span class="badge text-bg-secondary">Open</span>
              </a>
              {% empty %}
              <div class="text-muted">No attachments.</div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">No attachments.</div>
            {% endif %}
          </div>

          <!-- Comments -->
          <div class="tab-pane fade" id="comments" role="tabpanel">

            <div class="mb-4">
              <h5 class="mb-2">Conversation</h5>

              {% if ticket.comments.count == 0 %}
              <div class="text-muted">No comments yet.</div>
              {% else %}
              <div class="vstack gap-3">
                {% for c in ticket.comments.all %}
                <div class="card {% if c.is_internal %}border-warning{% else %}border-light{% endif %}">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="fw-semibold">
                          {{ c.author|default:"Unknown" }}
                          {% if c.is_internal %}
                          <span class="badge text-bg-warning ms-2">Internal</span>
                          {% endif %}
                        </div>
                        <div class="text-muted small">{{ c.created_at|date:"M d, Y H:i" }}</div>
                      </div>
                    </div>

                    <div class="mt-2">
                      {{ c.message|linebreaksbr }}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <hr>

            <h5 class="mb-2">Add Comment</h5>
            <form method="post" action="{% url 'ticket_add_comment' ticket.pk %}" novalidate>
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea class="form-control" name="message" rows="4" required></textarea>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="is_internal" value="on" id="is_internal">
                <label class="form-check-label" for="is_internal">
                  Internal note (employees will be forced to public)
                </label>
              </div>

              <button class="btn btn-primary" type="submit">Send</button>
            </form>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}